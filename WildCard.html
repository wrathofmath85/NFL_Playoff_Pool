<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Wild Card Lines</title>
<style>
  /* ===== Chicago Bears palette ===== */
  :root{
    --navy:#0B162A;
    --navy-2:#101b33;
    --navy-3:#0e1424;
    --orange:#DC4405;
    --muted:#a9b5c7;
    --border:#27385e;
    --text:#eef3ff;
  }

  html,body{margin:0;background:var(--navy);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;}
  .wrap{max-width:1100px;margin:auto;padding:16px 22px 28px;}

  /* ===== Sticky header ===== */
  .topbar{
    position:sticky;top:0;z-index:50;
    backdrop-filter:saturate(130%) blur(4px);
    background:color-mix(in srgb, var(--navy) 85%, black 15%);
    border-bottom:2px solid var(--orange);
  }
  .topbar .inner{max-width:1100px;margin:auto;padding:10px 22px;display:grid;gap:10px;grid-template-columns:1fr repeat(3,minmax(140px,auto));align-items:end}
  .brand{font-weight:800;letter-spacing:.3px}
  .brand em{color:var(--orange);font-style:normal}
  .field{display:flex;flex-direction:column;gap:6px}
  .field label{font-size:.78rem;color:var(--muted)}
  select,input.read{
    appearance:none;width:100%;box-sizing:border-box;border-radius:10px;border:1px solid var(--border);
    background:var(--navy-2);color:var(--text);padding:10px 12px;font-size:15px;outline:none;
  }
  .totals{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:6px}
  .chip{border:1px solid var(--border);background:var(--navy-2);border-radius:999px;padding:6px 10px;font-size:.9rem}
  .chip strong{color:var(--orange)}
  @media (max-width:860px){.topbar .inner{grid-template-columns:1fr}.field{max-width:100%}}

  /* ===== Games ===== */
  h1{margin:14px 0 8px}
  .hint{color:var(--muted);margin:0 0 12px}
  .game{background:var(--navy-3);border:1px solid var(--border);border-radius:16px;padding:14px;margin:12px 0}
  .head{display:flex;gap:10px;align-items:center;flex-wrap:wrap;border-bottom:1px dashed var(--border);padding:0 4px 10px;margin-bottom:8px}
  .when{color:var(--muted);font-size:.92rem}
  .teams{font-weight:700;color:var(--orange)}
  .rowlabel{grid-column:1/-1;color:var(--muted);font-size:.84rem;margin-top:6px}
  .row{display:grid;grid-template-columns:1fr 1fr 120px 140px;gap:8px;align-items:stretch;margin:8px 0}
  @media (max-width:780px){.row{grid-template-columns:1fr}}

  .pill{
    border:1px solid var(--border);
    background:var(--navy-2);
    border-radius:10px;
    padding:10px;
    cursor:pointer;
    display:flex;
    justify-content:space-between;
    gap:8px;
    color:var(--orange);
    font-weight:600;
    transition:background .15s,box-shadow .15s,color .15s;
  }
  .pill:hover{background:#16264a;color:#ff6a1a}
  .pill.active{
    box-shadow:0 0 0 2px var(--orange) inset;
    background:#1c2946;
    color:#fff;
  }
  .pill .odds{opacity:.9}

  .money input{
    width:100%;height:100%;box-sizing:border-box;border-radius:10px;border:1px solid var(--border);
    background:var(--navy-2);color:var(--text);font-size:16px;padding:10px 12px;outline:none;
  }
  .payout{
    background:var(--navy-2);border:1px solid var(--border);border-radius:10px;display:flex;align-items:center;justify-content:center;
    font-weight:800;color:var(--orange)
  }
  .warn{color:#ffd18c;font-size:.85rem;margin-top:2px}
  footer{color:var(--muted);font-size:.85rem;margin-top:18px}

  /* submit button */
  .submitBtn{
    margin:16px 0 6px;
    padding:10px 20px;
    border-radius:999px;
    border:1px solid var(--orange);
    background:var(--orange);
    color:#fff;
    font-weight:700;
    cursor:pointer;
  }
  .submitBtn:hover{background:#ff6a1a}
</style>
</head>
<body>
  <!-- ===== Sticky header ===== -->
  <header class="topbar">
    <div class="inner">
      <div class="field" style="grid-column:1 / -1">
        <div class="brand">Wild Card Lines • <em>Pick’em</em></div>
        <div class="totals">
          <span class="chip">Email: <strong id="hdrEmail">—</strong></span>
          <span class="chip">Begin: <strong id="hdrBegin">$0.00</strong></span>
          <span class="chip">Remaining: <strong id="hdrRemain">$0.00</strong></span>
          <span class="chip">Committed: <strong id="hdrCommitted">$0.00</strong></span>
        </div>
      </div>
      <div class="field" style="grid-column:1 / -1">
        <label for="playerSelect">Select your name</label>
        <select id="playerSelect"><option>Loading players…</option></select>
      </div>
    </div>
  </header>

  <div class="wrap">
    <h1>Games</h1>
    <p class="hint">Each game has <b>Moneyline</b>, <b>Spread</b>, and <b>Total (O/U)</b> rows. Click a pill, type a wager, and we’ll compute <em>To Win</em> for that row. Your <b>Remaining</b> budget updates automatically and wagers are capped to your Begin amount.</p>

    <div id="games"></div>

    <button id="submitBtn" class="submitBtn">Submit Picks</button>
    <div id="submitStatus" class="hint"></div>

    <footer>Payout: negative odds → wager + (wager / |odds|) * 100; positive odds → wager + (wager / 100) * odds.</footer>
  </div>

  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    /* ===== Config / URLs ===== */
    const WEEK_LABEL = "Wild Card"; // change this once; header + Week column will follow

    const PLAYERS_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTM_TPwD9YQTag_DkvjAiadp7w3vz2OfJllUdqZoCK6MSUFoaIBWMPRhwjHoVFrmrg4liQwSxQyEaic/pub?gid=0&single=true&output=csv";
    const ODDS_CSV_URL    = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTYrB51f7zbtdxC794-EO-FgaqHq3ZFmKilje5qGmCJJ9SjuIIMLfzlOZCf1p5PGpSc9N_swz9cRBM7/pub?gid=0&single=true&output=csv";

    // Published CSV (read-only) – kept for reference
    const PICKS_SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTGQ-_w6xMpMsaFPNq8HwQ8z8PHs3x3m5lre7bhA-tqMZcuij6L7-I61-4V-vBbBXFBXVPV5SaltVg7/pub?gid=0&single=true&output=csv";

    // Apps Script web-app URL that appends to the sheet
    const SUBMIT_ENDPOINT = "https://script.google.com/macros/s/AKfycbxnDlYdKJZ8PkWYQlniFRDCp4UTrUjbMcapFbeu6Njjblu2ocdwJaN3EJTsXVh5yKSnYA/exec";

    /* ===== Odds sheet columns ===== */
    const COLS = {
      date: "Date",
      time: "Time",
      channel: "Channel",
      away: "Away",
      aSu: "A SU Line",
      aSpread: "A Spread",
      aSpreadLine: "A Spread Line",
      home: "Home",
      hSu: "H SU Line",
      hSpread: "H Spread",
      hSpreadLine: "H Spread Line",
      ouTotal: "Over/Under",
      oLine: "O Line",
      uLine: "U Line"
    };

    let players = [];
    let currentPlayer = null;

    /* ===== Helpers ===== */
    const $ = sel => document.querySelector(sel);
    const fmtSigned = n => (n === "" || n === null || isNaN(n)) ? "" : (Number(n) > 0 ? `+${Number(n)}` : `${Number(n)}`);
    const fmtMoney  = v => `$${Number(v||0).toFixed(2)}`;
    const parseMoney= v => (typeof v === "number") ? v : Number(String(v||"").replace(/[$,]/g,"")) || 0;

    function computePayout(wager, odds){
      const w = Number(wager||0), o = Number(odds);
      if(!w || !o) return 0;
      if(o < 0) return w + (w/Math.abs(o))*100;
      return w + (w/100)*o;
    }

    function sumCommitted(){
      let total = 0;
      document.querySelectorAll("input.wager").forEach(inp => { total += Number(inp.value||0); });
      return total;
    }

    function refreshHeaderTotals(){
      const committed = sumCommitted();
      const begin = Number(currentPlayer?.begin || 0);
      const remaining = Math.max(0, begin - committed);
      $("#hdrCommitted").textContent = fmtMoney(committed);
      $("#hdrRemain").textContent    = fmtMoney(remaining);
      $("#hdrBegin").textContent     = fmtMoney(begin);
      $("#hdrEmail").textContent     = currentPlayer?.email || "—";
    }

    /* ===== Pill & Row logic ===== */
    function pill(label, odds, gameId, group){
      const el = document.createElement("button");
      el.type = "button";
      el.className = "pill";
      el.dataset.gameId = gameId;
      el.dataset.group  = group;   // ml | spread | total
      el.dataset.odds   = odds ?? "";
      el.innerHTML = `<span class="name">${label}</span><span class="odds">${fmtSigned(odds)}</span>`;

      el.addEventListener("click", () => {
        const scope = document.querySelector(`.game[data-id="${gameId}"] .row[data-group="${group}"]`);
        const wasActive = el.classList.contains("active");

        // Toggle: if already active, unselect; else select and clear other in row
        if (wasActive) {
          el.classList.remove("active");
        } else {
          scope.querySelectorAll(".pill").forEach(p=>p.classList.remove("active"));
          el.classList.add("active");
        }
        updateRow(scope);
        refreshHeaderTotals();
      });

      return el;
    }

    function updateRow(scope){
      const wagerInput = scope.querySelector("input.wager");
      const payoutEl   = scope.querySelector(".payout");
      const warnEl     = scope.nextElementSibling?.classList.contains("warn") ? scope.nextElementSibling : null;

      // ----- Budget clamp for this one input -----
      const begin = Number(currentPlayer?.begin || 0);
      const before = Number(wagerInput.value || 0);

      // Current total including this input
      const totalNow = sumCommitted();
      const over = Math.max(0, totalNow - begin);
      if (over > 0) {
        const newVal = Math.max(0, before - over);
        wagerInput.value = Math.floor(newVal).toString();
        if (warnEl) warnEl.textContent = newVal === 0 ? "Budget reached." : `Capped to remaining.`;
      } else if (warnEl) {
        warnEl.textContent = "";
      }

      const active = scope.querySelector(".pill.active");
      const wager  = Number(wagerInput.value||0);

      if(!active || !wager){
        payoutEl.textContent = "—";
        refreshHeaderTotals();
        return;
      }

      const odds = Number(active.dataset.odds);
      const total = computePayout(wager, odds);
      payoutEl.textContent = isFinite(total) ? fmtMoney(total) : "—";

      refreshHeaderTotals();
    }

    function buildRow(idx, group, label, pillLeft, pillRight){
      const lab = document.createElement("div");
      lab.className = "rowlabel";
      lab.textContent = label;

      const r = document.createElement("div");
      r.className = "row";
      r.dataset.group = group;

      r.append(pillLeft, pillRight);

      const wagerWrap = document.createElement("div");
      wagerWrap.className = "money";
      const wagerInput = document.createElement("input");
      wagerInput.type = "number";
      wagerInput.min = "0";
      wagerInput.step = "1";
      wagerInput.placeholder = "Wager";
      wagerInput.className = "wager";
      wagerInput.addEventListener("input", () => {
        updateRow(r);
      });
      wagerWrap.append(wagerInput);

      const payout = document.createElement("div");
      payout.className = "payout";
      payout.textContent = "—";

      r.append(wagerWrap, payout);

      const warn = document.createElement("div");
      warn.className = "warn";
      warn.textContent = "";

      const frag = document.createDocumentFragment();
      frag.append(lab, r, warn);
      return frag;
    }

    function buildGameRow(row, idx){
      const game = document.createElement("section");
      game.className = "game";
      game.dataset.id = idx;

      const head = document.createElement("div");
      head.className = "head";
      const teams = document.createElement("div");
      teams.className = "teams";
      teams.textContent = `${row[COLS.away]} @ ${row[COLS.home]}`;
      const when = document.createElement("div");
      when.className = "when";
      when.textContent = `${row[COLS.date]} • ${row[COLS.time]} • ${row[COLS.channel]}`;
      head.append(teams, when);
      game.appendChild(head);

      // Moneyline
      game.appendChild(buildRow(
        idx, "ml", "Moneyline",
        pill(row[COLS.away], row[COLS.aSu], idx, "ml"),
        pill(row[COLS.home], row[COLS.hSu], idx, "ml")
      ));

      // Spread
      game.appendChild(buildRow(
        idx, "spread", "Spread",
        pill(`${row[COLS.away]} (${fmtSigned(row[COLS.aSpread])})`, row[COLS.aSpreadLine], idx, "spread"),
        pill(`${row[COLS.home]} (${fmtSigned(row[COLS.hSpread])})`, row[COLS.hSpreadLine], idx, "spread")
      ));

      // Total
      game.appendChild(buildRow(
        idx, "total", "Total (O/U)",
        pill(`Over ${row[COLS.ouTotal]}`, row[COLS.oLine], idx, "total"),
        pill(`Under ${row[COLS.ouTotal]}`, row[COLS.uLine], idx, "total")
      ));

      return game;
    }

    function renderGames(rows){
      const container = document.getElementById("games");
      container.innerHTML = "";
      rows.forEach((r,i)=>{
        if(!(r[COLS.away] && r[COLS.home])) return;
        container.appendChild(buildGameRow(r,i));
      });
      refreshHeaderTotals();
    }

    /* ===== Collect picks for submit ===== */
    function collectPicks(){
      const picks = [];
      if (!currentPlayer) {
        alert("Please select your name at the top first.");
        return picks;
      }
      document.querySelectorAll(".game").forEach(game => {
        ["ml","spread","total"].forEach(group => {
          const row = game.querySelector(`.row[data-group="${group}"]`);
          if (!row) return;
          const active = row.querySelector(".pill.active");
          const wager = Number(row.querySelector("input.wager").value || 0);
          if (active && wager > 0){
            const pickLabel = active.querySelector(".name").textContent.trim();
            picks.push({
              Week: WEEK_LABEL,
              Name: currentPlayer.name,
              Pick: pickLabel,
              Wager: wager
            });
          }
        });
      });
      return picks;
    }

    async function submitPicks(){
      const statusEl = $("#submitStatus");
      statusEl.textContent = "";
      const picks = collectPicks();
      if (!picks.length){
        alert("No picks to submit. Make at least one selection with a wager.");
        return;
      }

      if (!SUBMIT_ENDPOINT || SUBMIT_ENDPOINT.startsWith("REPLACE_")){
        console.log("Picks that would be submitted to the sheet:", picks);
        alert("Submit endpoint is not configured yet. Picks have been logged to the browser console.");
        return;
      }

      try{
        const params = new URLSearchParams();
        params.append("data", JSON.stringify({
          rows: picks,
          week: WEEK_LABEL,
          targetCsv: PICKS_SHEET_CSV_URL
        }));

        const resp = await fetch(SUBMIT_ENDPOINT, {
          method: "POST",
          body: params
        });

        const text = await resp.text();
        console.log("Submit response:", text);
        statusEl.textContent = "Picks submitted!";
      }catch(err){
        console.error(err);
        statusEl.textContent = "Error submitting picks. Check console for details.";
      }
    }  // <--- this was missing

    /* ===== Data loading ===== */
    function loadPlayers(){
      return new Promise(resolve=>{
        Papa.parse(PLAYERS_CSV_URL,{download:true,header:true,dynamicTyping:false,skipEmptyLines:true,
          complete:res=>{
            players=(res.data||[]).filter(r=>r["Player"]).map(r=>({
              name:r["Player"],email:r["Email"]??"",begin:parseMoney(r["Begin"])
            }));
            const sel=$("#playerSelect");
            sel.innerHTML=`<option value="">-- Select --</option>`+players.map((p,i)=>`<option value="${i}">${p.name}</option>`).join("");
            sel.addEventListener("change",()=>{
              currentPlayer=players[sel.value]??null;
              refreshHeaderTotals();
            });
            resolve();
          }});
      });
    }

    function loadOdds(){
      return new Promise(resolve=>{
        Papa.parse(ODDS_CSV_URL,{download:true,header:true,dynamicTyping:true,skipEmptyLines:true,
          complete:res=>{renderGames(res.data||[]);resolve();}});
      });
    }

    (async function init(){
      // Apply WEEK_LABEL to header & page title
      const brandEl = document.querySelector(".brand");
      if (brandEl){
        brandEl.innerHTML = WEEK_LABEL + " Lines • <em>Pick’em</em>";
      }
      document.title = WEEK_LABEL + " Lines";

      await Promise.all([loadPlayers(),loadOdds()]);

      const submitBtn = $("#submitBtn");
      if (submitBtn) submitBtn.addEventListener("click", submitPicks);
    })();
  </script>
</body>
</html>
